field_sets:
  osm_id:
    - name: osm_id
      sql: osm_id::text
  geomt:
    - name: geom
      sql: ST_AsMVTGeom(ST_SimplifyPreserveTopology(geometry, !PIXEL_WIDTH! / 4), !BBOX!)
  geom:
    - name: geom
      sql: ST_AsMVTGeom(ST_SimplifyPreserveTopology(geom, !PIXEL_WIDTH! / 4), !BBOX!)
  tags_hstore:
    - name: tags
      sql: to_json(tags)::text
  tags:
    - name: tags
      sql: tags::text
  stats:
    - name: stats
      sql: stats::text
      
layers:
  - name: pdm_project_poteaux
    map:
      - pdm_project_poteaux
    geometry_type: Point
    max_zoom: 15
    field_sets: [geom, osm_id, tags]
    id_field: gid
    from: pdm_project_poteaux
    where: geom && !BBOX!

  - name: pdm_project_poteaux_eld
    map:
      - pdm_project_poteaux
    geometry_type: Point
    min_zoom: 7
    max_zoom: 15
    field_sets: [geomt, osm_id, tags_hstore]
    id_field: osm_id
    from: osm_power_tower
    where: tags->'operator' IS NOT NULL AND tags->'operator'!='Enedis' AND geometry && !BBOX!

  - name: pdm_project_poteaux_operator
    map:
      - pdm_project_poteaux
    geometry_type: Point
    min_zoom: 7
    max_zoom: 15
    field_sets: [geomt, osm_id, tags_hstore]
    id_field: osm_id
    from: osm_power_tower
    where: tags->'operator' IS NULL AND geometry && !BBOX!

  - name: pdm_stats_poteaux
    map:
      - pdm_stats_poteaux
    geometry_type: Point
    max_zoom: 15
    field_sets: [geom, stats]
    id_field: id
    fields:
      - name: project
      - name: boundary
      - name: name
      - name: admin_level
      - name: nb
    from: pdm_boundary_tiles
    where: >
      project='2021-01_poteaux'
      AND geom && !BBOX!
      AND ((admin_level=4 AND !ZOOM! <= 5) OR (admin_level=6 AND !ZOOM! BETWEEN 5 AND 8) OR (admin_level=8 AND !ZOOM! >= 8))

  - name: pdm_project_substations
    map:
      - pdm_project_substations
    geometry_type: Point
    max_zoom: 15
    field_sets: [geom, osm_id, tags]
    id_field: gid
    from: pdm_project_substations
    where: geom && !BBOX!

  - name: pdm_stats_substations
    map:
      - pdm_stats_substations
    geometry_type: Point
    max_zoom: 15
    field_sets: [geom, stats]
    id_field: id
    fields:
      - name: project
      - name: boundary
      - name: name
      - name: admin_level
      - name: nb
    from: pdm_boundary_tiles
    where: >
      project='2021-01_substations'
      AND geom && !BBOX!
      AND ((admin_level=4 AND !ZOOM! <= 5) OR (admin_level=6 AND !ZOOM! BETWEEN 5 AND 8) OR (admin_level=8 AND !ZOOM! >= 8))
