field_sets:
  geom:
    - name: geom
      sql: ST_AsMVTGeom(ST_SimplifyPreserveTopology(geometry, !PIXEL_WIDTH! / 4), !BBOX!)
    - name: is_node
      sql: (ST_GeometryType(geometry) = 'ST_Point')
  geom_centroid:
    - name: geom
      sql: ST_AsMVTGeom(ST_Centroid(geometry), !BBOX!)
    - name: is_node
      sql: (ST_GeometryType(geometry) = 'ST_Point')
  frequency:
    - name: frequency
      sql: first_semi(tags -> 'frequency')
  area:
    - name: area
      sql: round(ST_Area(geometry))
  voltages:
    - name: voltage
      sql: convert_voltage(voltage) / 1000
    - name: voltage_2
      sql: convert_voltage(nth_semi(voltage, 2)) / 1000
    - name: voltage_3
      sql: convert_voltage(nth_semi(voltage, 3)) / 1000
  wiki:
    - name: wikidata
      sql: tags -> 'wikidata'
    - name: wikipedia
      sql: tags -> 'wikipedia'
  name:
    - name: name
      sql: tags -> 'name'
    - name: name_en
      sql: tags -> 'name:en'
    - name: operator
      sql: tags -> 'operator'
    - name: ref
      sql: tags -> 'ref'
  construction:
    - name: construction
      sql: (tags -> 'construction:power') IS NOT NULL OR (tags -> 'construction:telecom') IS NOT NULL OR (tags -> 'construction:pipeline') IS NOT NULL
  url:
    - name: url
      sql: osm_url(tags)
  source:
    - name: source
      sql: first_semi(source)
  output:
    - name: output
      sql: convert_power(output) / 1e6
  generator_output:
    - name: output
      sql: convert_power(tags -> 'generator:output:electricity')/1e6
  support_structure:
    - name: height
      sql: tags -> 'height'
    - name: material
      sql: tags -> 'material'
    - name: structure
      sql: tags -> 'structure'
  support_topology:
    - name: line_attachment
      sql: tags -> 'line_attachment'
    - name: line_management
      sql: tags -> 'line_management'
  remote_control:
    - name: remotely_controllable
      sql: tags -> 'remotely_controllable'
  telecom_medium:
    - name: telecom:medium
      sql: tags -> 'telecom:medium'
  utility:
    - name: utility
      sql: tags -> 'utility'
      
layers:
  - name: power_line
    map:
      - openinframap
      - gespot
    geometry_type: LineString
    max_zoom: 18
    field_sets: [geom, name, frequency, wiki, construction]
    id_field: gid
    fields:
      - name: type
      - name: tunnel
      - name: location
      - name: line
      - name: ref_len
        sql: char_length(tags -> 'ref')
      - name: voltage
        sql: voltages[1]
      - name: voltage_2
        sql: voltages[2]
      - name: voltage_3
        sql: voltages[3]
      - name: circuits
      - name: url
        sql: osm_url(tags)
    from: power_lines(!ZOOM!, !BBOX!)
    where: >
      ST_Length(geometry) > !PIXEL_WIDTH! / 4 AND
      (convert_voltage(voltage) > 200000 OR
        !ZOOM! >= 4 AND convert_voltage(voltage) > 100000 OR
        !ZOOM! >= 6 AND convert_voltage(voltage) > 30000 OR
        !ZOOM! >= 7)
    order_by: convert_voltage(voltage) ASC NULLS FIRST

  - name: power_tower
    map:
      - openinframap
      - gespot
    geometry_type: Point
    min_zoom: 10
    max_zoom: 18
    field_sets: [geom, name, construction, url, support_structure, support_topology, remote_control]
    id_field: osm_id
    fields:
      - name: transition
      - name: type
      - name: switch
        sql: tags -> 'switch'
      - name: transformer
        sql: tags -> 'transformer'
      - name: substation
        sql: tags -> 'substation'
      - name: utility
        sql: "'power'"
    from: osm_power_tower
    where: geometry && !BBOX!

  - name: power_substation
    map:
      - openinframap
      - gespot
    geometry_type: Polygon
    min_zoom: 13
    max_zoom: 18
    field_sets: [geom, name, frequency, voltages, construction, wiki, url, remote_control]
    fields:
      - name: substation
    id_field: osm_id
    from: substation
    where: geometry && !BBOX!
    order_by: convert_voltage(voltage) ASC NULLS FIRST

  - name: power_substation_point
    map:
      - openinframap
      - gespot
    geometry_type: Point
    min_zoom: 5
    max_zoom: 18
    field_sets: [geom_centroid, area, name, frequency, voltages, construction, wiki, url, remote_control]
    fields:
      - name: substation
    id_field: osm_id
    from: substation
    where: >
      geometry && !BBOX! AND (
        (!ZOOM! >= 5 AND convert_voltage(voltage) > 200000) OR
        (!ZOOM! >= 9 AND convert_voltage(voltage) > 50000) OR
        (!ZOOM! >= 10)
      )
    order_by: convert_voltage(voltage) ASC NULLS FIRST

  - name: power_plant
    geometry_type: Polygon
    min_zoom: 5
    field_sets: [geom, name, wiki, source, output, construction, url]
    id_field: osm_id
    fields:
      - name: storage
        sql: tags -> 'plant:storage'
      - name: repd_id
        sql: tags -> 'repd:id'
    from: power_plant
    where: >
      geometry && !BBOX! AND
      (!ZOOM! >= 11 OR ST_Area(geometry) > (!PIXEL_WIDTH! ^ 2 * 4))
    order_by: convert_power(output) ASC NULLS FIRST

  - name: power_plant_point
    geometry_type: Point
    min_zoom: 5
    field_sets: [geom_centroid, name, wiki, source, output, construction, url]
    id_field: osm_id
    fields:
      - name: storage
        sql: tags -> 'plant:storage'
      - name: repd_id
        sql: tags -> 'repd:id'
    from: power_plant
    where: >
      geometry && !BBOX! AND
      (!ZOOM! >= 5 AND (convert_power(output) / 1e6) > 1000 OR
       !ZOOM! >= 6 AND (convert_power(output) / 1e6) > 500 OR
       !ZOOM! >= 7 AND (convert_power(output) / 1e6) > 250 OR
       !ZOOM! >= 8) AND
       NOT ST_IsEmpty(geometry)
    order_by: convert_power(output) ASC NULLS FIRST

  - name: power_generator
    geometry_type: Point
    min_zoom: 9
    field_sets: [geom_centroid, name, wiki, source, construction, url, generator_output]
    id_field: osm_id
    from: osm_power_generator
    where: geometry && !BBOX!

  - name: power_generator_area
    geometry_type: Polygon
    min_zoom: 13
    field_sets: [geom, name, wiki, source, construction, url, generator_output]
    id_field: osm_id
    from: osm_power_generator
    where: geometry && !BBOX! AND construction = '' AND ST_GeometryType(geometry) IN ('ST_Polygon', 'ST_MultiPolygon')

  - name: power_transformer
    geometry_type: Point
    min_zoom: 14
    field_sets: [geom_centroid, name]
    id_field: osm_id
    from: osm_power_switchgear
    where: type = 'transformer' AND geometry && !BBOX!

  - name: power_compensator
    geometry_type: Point
    min_zoom: 14
    field_sets: [geom_centroid, name]
    id_field: osm_id
    from: osm_power_switchgear
    where: type = 'compensator' AND geometry && !BBOX!

  - name: power_switch
    geometry_type: Point
    min_zoom: 14
    field_sets: [geom_centroid, name]
    id_field: osm_id
    from: osm_power_switchgear
    where: type = 'switch' AND geometry && !BBOX!

  - name: power_heatmap_solar
    map: 
      - solar_heatmap
    geometry_type: Point
    min_zoom: 2
    id_field: gid
    fields:
      - name: gid
        sql: max(osm_id)
      - name: geom
        sql: ST_AsMVTGeom(ST_SnapToGrid(ST_Centroid(geometry), !PIXEL_WIDTH! / 2, !PIXEL_WIDTH! / 2), !BBOX!)
      - name: output
        sql: >
          round(sum(coalesce(
                      convert_power(tags -> 'generator:output:electricity'),
                      modules_output(tags -> 'generator:solar:modules'),
                      solar_output(geometry),
                      0)
                    )::NUMERIC / 1e3,
                2)
    from: osm_power_generator
    where: >
      source = 'solar' AND
      construction = '' AND
      geometry && !BBOX!
      GROUP BY geom

  - name: telecoms_communication_line
    map:
      - openinframap
      - gespot
    geometry_type: LineString
    id_field: osm_id
    min_zoom: 2
    max_zoom: 18
    field_sets: [geom, name, telecom_medium, construction]
    fields:
      - name: ref
        sql: tags -> 'ref'
      - name: capacity
        sql: tags -> 'capacity'
      - name: location
    from: osm_telecom_cable
    where: >
      geometry && !BBOX!
      AND ST_Length(geometry) > !PIXEL_WIDTH! / 4

  - name: telecoms_sites
    geometry_type: Polygon
    min_zoom: 10
    id_field: osm_id
    field_sets: [geom, name, wiki, telecom_medium]
    fields:
      - name: ref
      - name: telecom
        sql: type
      - name: ref:FR:ARCEP
        sql: tags -> 'ref:FR:ARCEP'
      - name: ref:FR:PTT
        sql: tags -> 'ref:FR:PTT'
      - name: ref:FR:Orange
        sql: tags -> 'ref:FR:Orange'
      - name: ref:FR:SFR
        sql: tags -> 'ref:FR:SFR'
    from: osm_telecom_sites
    where: geometry && !BBOX!

  - name: telecoms_sites_points
    geometry_type: Point
    min_zoom: 8
    id_field: osm_id
    field_sets: [geom_centroid, is_node, area, name, wiki, telecom_medium]
    fields:
      - name: ref
      - name: telecom
        sql: type
      - name: ref:FR:ARCEP
        sql: tags -> 'ref:FR:ARCEP'
      - name: ref:FR:PTT
        sql: tags -> 'ref:FR:PTT'
      - name: ref:FR:Orange
        sql: tags -> 'ref:FR:Orange'
      - name: ref:FR:SFR
        sql: tags -> 'ref:FR:SFR'
    from: osm_telecom_sites
    where: geometry && !BBOX!

  - name: telecoms_mast
    map:
      - openinframap
      - gespot
    geometry_type: Point
    min_zoom: 10
    max_zoom: 18
    id_field: osm_id
    field_sets: [geom_centroid, name, wiki]
    from: osm_telecom_antennas
    where: >
      (tags -> 'mast:type' IN ('communication', 'communications', 'broadcast')
       OR tags -> 'tower:type' IN ('communication', 'radio', 'antenna'))
      AND geometry && !BBOX!

  - name: petroleum_pipeline
    geometry_type: LineString
    min_zoom: 2
    max_zoom: 18
    id_field: osm_id
    field_sets: [geom, name, wiki]
    fields:
      - name: location
        sql: tags -> 'location'
      - name: substance
      - name: type
    from: osm_pipeline
    where: >
      COALESCE(substance, type) IN ('natural_gas', 'gas', 'oil', 'fuel', 'cng', 'lng', 'hydrocarbons')
      AND construction = ''
      AND geometry && !BBOX!
      AND ST_Length(geometry) > !PIXEL_WIDTH! / 4

  - name: petroleum_marker
    geometry_type: Point
    min_zoom: 15
    max_zoom: 18
    id_field: osm_id
    field_sets: [geom, is_node, name, wiki, utility]
    fields:
      - name: location
        sql: tags -> 'location'
      - name: type
      - name: colour
    from: osm_marker
    where: >
      utility IN ('gas', 'oil')
      AND geometry && !BBOX!

  - name: petroleum_well
    geometry_type: Point
    min_zoom: 10
    id_field: osm_id
    field_sets: [geom, name]
    from: osm_petroleum_well
    where: geometry && !BBOX!

  - name: petroleum_site
    geometry_type: Polygon
    min_zoom: 13
    max_zoom: 18
    id_field: osm_id
    field_sets: [geom, name, construction, wiki, utility]
    fields:
      - name: substation
        sql: tags -> 'substation'
      - name: substance
        sql: tags -> 'substance'
    from: osm_petroleum_site
    where: >
      COALESCE(tags->'substance', type) IN ('natural_gas', 'gas', 'oil', 'fuel', 'cng', 'lng', 'hydrocarbons')
      AND geometry && !BBOX!

  - name: petroleum_site_point
    geometry_type: Point
    min_zoom: 5
    max_zoom: 18
    field_sets: [geom_centroid, area, name, construction, wiki, utility]
    fields:
      - name: substation
        sql: tags -> 'substation'
      - name: substance
        sql: tags -> 'substance'
    id_field: osm_id
    from: osm_petroleum_site
    where: >
      COALESCE(tags->'substance', type) IN ('natural_gas', 'gas', 'oil', 'fuel', 'cng', 'lng', 'hydrocarbons')
      AND geometry && !BBOX!

  - name: water_ways
    geometry_type: LineString
    min_zoom: 3
    id_field: osm_id
    field_sets: [geom, name]
    fields:
      - name: type
      - name: tunnel
        sql: tunnel
      - name: diameter
        sql: diameter
      - name: usage
        sql: usage
    from: osm_waterway
    where: > 
      geometry && !BBOX! AND
      ST_Length(geometry) > !PIXEL_WIDTH! / 4

  - name: utility_support
    map: 
      - gespot
    geometry_type: Point
    min_zoom: 10
    max_zoom: 18
    id_field: osm_id
    field_sets: [geom, name, is_node, utility, construction, support_structure, support_topology]
    fields:
      - name: type
      - name: transition
    from: osm_utility_support
    where: geometry && !BBOX!
